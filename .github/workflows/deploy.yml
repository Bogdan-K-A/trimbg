name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repo
        uses: actions/checkout@v3

      - name: DEBUG: Show key
        run: |
            echo "${{ secrets.REMOTE_KEY }}" | head -n 5

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_KEY }}
          script: |
            echo "üìÅ –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            if [ ! -d /var/www/fastuser/data/www/trimbg.pro ]; then
              git clone https://github.com/Bogdan-K-A/trimbg.git /var/www/fastuser/data/www/trimbg.pro
            fi

            cd /var/www/fastuser/data/www/trimbg.pro

            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥"
            git pull origin main

            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
            npm install

            echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞"
            npm run build

            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend"
            cd backend
            npm install
            cd ..

            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2"
            pm2 startOrReload ecosystem.config.js
